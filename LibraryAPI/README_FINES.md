# Система штрафов LibraryAPI

## Описание

Реализована система честного начисления штрафов с защитой от дублирования. Система автоматически начисляет штрафы за просроченные книги и предоставляет API для ручного управления штрафами.

## Основные возможности

### 1. Автоматическое начисление штрафов
- Штрафы начисляются только за новые дни просрочки
- Защита от дублирования - один штраф за день для каждого резервирования
- Автоматическое уведомление пользователей о новых штрафах
- Обновление статуса резервирования на "Просрочена"

### 2. Ручное управление штрафами
- Начисление штрафов администратором
- Просмотр истории штрафов пользователя
- Оплата штрафов
- Детальная информация о каждом штрафе

## API Endpoints

### POST /api/users/{userId}/fine
Начисляет штраф пользователю.

**Параметры запроса:**
```json
{
  "reservationId": "guid (необязательно)",
  "amount": 100.50,
  "reason": "Просрочка возврата книги",
  "overdueDays": 5,
  "notes": "Дополнительные заметки",
  "fineType": "Overdue"
}
```

**Ответ при успехе (200):**
```json
{
  "message": "Штраф успешно начислен",
  "fineId": "guid",
  "amount": 100.50,
  "totalFineAmount": 250.00,
  "reason": "Просрочка возврата книги",
  "overdueDays": 5,
  "calculatedForDate": "2024-06-14",
  "reservationId": "guid",
  "bookTitle": "Название книги"
}
```

**Защита от дублирования:**
Если штраф за указанные дни уже был начислен для данного резервирования, возвращается ошибка:
```json
{
  "message": "Штраф за эти дни уже был начислен для данного резервирования",
  "existingFineId": "guid",
  "existingFineAmount": 50.00,
  "calculatedDate": "2024-06-14"
}
```

### GET /api/users/{userId}/fines
Получает историю штрафов пользователя.

**Параметры запроса:**
- `isPaid` (bool, необязательно) - фильтр по статусу оплаты

**Ответ:**
```json
{
  "userId": "guid",
  "userName": "Иван Иванов",
  "totalFineAmount": 250.00,
  "paidAmount": 100.00,
  "unpaidAmount": 150.00,
  "totalFines": 5,
  "paidFines": 2,
  "unpaidFines": 3,
  "fineRecords": [
    {
      "id": "guid",
      "userId": "guid",
      "reservationId": "guid",
      "amount": 50.00,
      "reason": "Просрочка возврата книги",
      "overdueDays": 5,
      "createdAt": "2024-06-14T10:00:00Z",
      "paidAt": null,
      "isPaid": false,
      "notes": "Автоматически начислено",
      "calculatedForDate": "2024-06-14",
      "fineType": "Overdue",
      "userName": "Иван Иванов",
      "bookTitle": "Название книги",
      "reservationStatus": "Просрочена"
    }
  ]
}
```

### POST /api/users/{userId}/pay-fine
Отмечает штраф как оплаченный.

**Параметры запроса:**
```json
{
  "fineId": "guid",
  "paymentNotes": "Оплачено наличными"
}
```

**Ответ:**
```json
{
  "message": "Штраф успешно оплачен",
  "fineId": "guid",
  "paidAmount": 50.00,
  "remainingFineAmount": 200.00,
  "paidAt": "2024-06-14T12:00:00Z"
}
```

## Логика защиты от дублирования

### Принцип работы
1. **Дата расчета**: Каждый штраф привязан к конкретной дате (`CalculatedForDate`)
2. **Уникальность**: Для каждого резервирования может быть только один штраф определенного типа за конкретную дату
3. **Инкрементальное начисление**: Штрафы начисляются только за новые дни просрочки

### Пример работы
```
День 1: Книга просрочена на 1 день → Штраф 10₽ (всего: 10₽)
День 2: Книга просрочена на 2 дня → Штраф 10₽ за новый день (всего: 20₽)
День 3: Система запускается повторно → Штраф не начисляется (уже есть за этот день)
```

### Индексы базы данных
Для оптимизации проверок дублирования созданы индексы:
- `IX_FineRecords_Reservation_Date_Type` - по резервированию, дате и типу штрафа
- `IX_FineRecords_UserId_CreatedAt` - по пользователю и дате создания
- `IX_FineRecords_IsPaid` - по статусу оплаты

## Автоматическое начисление

### Фоновый сервис
Система автоматически проверяет просроченные резервирования каждые 30 минут через `NotificationBackgroundService`.

### Алгоритм работы
1. Находит все просроченные резервирования
2. Для каждого резервирования:
   - Проверяет, не был ли уже начислен штраф за сегодня
   - Находит последний штраф для этого резервирования
   - Вычисляет количество новых дней просрочки
   - Начисляет штраф только за новые дни
   - Отправляет уведомление пользователю
   - Обновляет статус резервирования

### Настройки
- **Ставка штрафа**: 10₽ за день (настраивается в коде)
- **Частота проверки**: каждые 30 минут
- **Типы штрафов**: "Overdue", "Damage", "Lost"

## Уведомления

При начислении штрафа автоматически отправляется уведомление пользователю с информацией:
- Сумма нового штрафа
- Общая сумма задолженности
- Причина штрафа
- Информация о просроченной книге
- Количество дней просрочки

## Модель данных

### FineRecord
```csharp
public class FineRecord
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public Guid? ReservationId { get; set; }
    public decimal Amount { get; set; }
    public string Reason { get; set; }
    public int? OverdueDays { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? PaidAt { get; set; }
    public bool IsPaid { get; set; }
    public string? Notes { get; set; }
    public DateTime? CalculatedForDate { get; set; } // Ключевое поле для защиты от дублирования
    public string? FineType { get; set; }
}
```

## Безопасность

- Все операции со штрафами требуют аутентификации
- Пользователи могут видеть только свои штрафы
- Начисление штрафов доступно только администраторам и библиотекарям
- Валидация всех входных данных
- Защита от SQL-инъекций через Entity Framework

## Мониторинг и логирование

Система ведет подробные логи:
- Начисление новых штрафов
- Ошибки при обработке
- Статистика обработанных резервирований
- Ошибки отправки уведомлений

## Примеры использования

### Начисление штрафа за просрочку
```bash
curl -X POST "https://api.library.com/api/users/123e4567-e89b-12d3-a456-426614174000/fine" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "reservationId": "987fcdeb-51a2-43d1-b123-456789abcdef",
    "amount": 50.00,
    "reason": "Просрочка возврата книги на 5 дней",
    "overdueDays": 5,
    "fineType": "Overdue"
  }'
```

### Получение истории штрафов
```bash
curl -X GET "https://api.library.com/api/users/123e4567-e89b-12d3-a456-426614174000/fines?isPaid=false" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Оплата штрафа
```bash
curl -X POST "https://api.library.com/api/users/123e4567-e89b-12d3-a456-426614174000/pay-fine" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "fineId": "111e2222-e33b-44d5-a666-777888999000",
    "paymentNotes": "Оплачено картой"
  }'
``` 