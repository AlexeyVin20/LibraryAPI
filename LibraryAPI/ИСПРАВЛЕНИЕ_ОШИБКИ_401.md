# ИСПРАВЛЕНИЕ ОШИБКИ 401 В МЕТОДАХ УВЕДОМЛЕНИЙ

## Проблема
Все методы API уведомлений возвращают ошибку `Error: response status is 401` из-за отсутствующего Bearer токена в заголовках запросов.

## Причины ошибки 401
1. **Отсутствует Bearer токен** в заголовке `Authorization`
2. **Неправильный формат токена** (должен быть `Bearer <token>`)
3. **Истекший токен**
4. **Неправильная конфигурация Swagger**
5. **Проблемы с JWT настройками**

## РЕШЕНИЯ

### 1. Проверка токена в Swagger

#### Шаг 1: Получите JWT токен
Сначала авторизуйтесь через эндпоинт `/api/auth/login`:

```http
POST /api/auth/login
Content-Type: application/json

{
  "username": "ваш_логин",
  "password": "ваш_пароль"
}
```

Ответ будет содержать токен:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "...",
  "expiresAt": "2024-01-01T00:00:00Z"
}
```

#### Шаг 2: Авторизация в Swagger
1. Откройте Swagger UI
2. Нажмите кнопку **"Authorize"** (замок) в правом верхнем углу
3. В поле **"Value"** введите: `Bearer ваш_токен`
   ```
   Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
   ```
4. Нажмите **"Authorize"**
5. Нажмите **"Close"**

#### Шаг 3: Тестирование
Теперь все запросы к API уведомлений должны работать с токеном.

### 2. Тестирование аутентификации

Используйте новый эндпоинт для диагностики:

```http
GET /api/notification/auth-test
Authorization: Bearer ваш_токен
```

Этот эндпоинт покажет:
- Статус аутентификации
- ID пользователя
- Все claims в токене
- Заголовок Authorization

### 3. Правильные клиентские запросы

#### JavaScript/Fetch
```javascript
const token = localStorage.getItem('jwt_token');

const response = await fetch('/api/notification', {
    headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
    }
});
```

#### Axios
```javascript
const api = axios.create({
    baseURL: '/api',
    headers: {
        'Content-Type': 'application/json'
    }
});

// Перехватчик для автоматического добавления токена
api.interceptors.request.use(config => {
    const token = localStorage.getItem('jwt_token');
    if (token) {
        config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
});
```

#### cURL
```bash
curl -X GET "http://localhost:5001/api/notification" \
     -H "Authorization: Bearer ваш_токен" \
     -H "Content-Type: application/json"
```

### 4. Проверка настроек JWT

Убедитесь, что в `appsettings.json` правильно настроены JWT параметры:

```json
{
  "JwtSettings": {
    "SecretKey": "a_very_long_and_secure_key_that_is_at_least_32_characters",
    "Issuer": "LibraryAPI",
    "Audience": "LibraryClient",
    "ExpirationInMinutes": 10080,
    "RefreshTokenExpirationInDays": 7
  }
}
```

### 5. Отладка проблем

#### Проверьте логи сервера
После внесенных изменений в `Program.cs`, сервер будет выводить отладочную информацию:
- `JWT Token received: ...` - токен получен
- `JWT Token validated successfully` - токен валиден
- `JWT Authentication failed: ...` - ошибка валидации
- `JWT Challenge: ...` - проблемы с авторизацией

#### Проверьте формат токена
Токен должен быть в формате:
```
Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

#### Проверьте срок действия токена
Токен действует 10080 минут (7 дней). Если токен истек, получите новый через `/api/auth/login`.

## ЧАСТЫЕ ОШИБКИ

### 1. Неправильный формат в Swagger
❌ **Неправильно:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

✅ **Правильно:**
```
Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 2. Отсутствие токена в localStorage
```javascript
// Проверьте наличие токена
const token = localStorage.getItem('jwt_token');
if (!token) {
    console.error('Токен не найден');
    window.location.href = '/login';
}
```

### 3. Истекший токен
```javascript
// Проверьте срок действия токена
const isTokenValid = (token) => {
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        return payload.exp > Date.now() / 1000;
    } catch {
        return false;
    }
};
```

## ГОТОВЫЕ ПРИМЕРЫ

Используйте файл `notification-client-examples.js` с готовыми функциями для всех методов уведомлений.

## ПРОВЕРОЧНЫЙ СПИСОК

- [ ] Получен JWT токен через `/api/auth/login`
- [ ] Токен добавлен в Swagger через кнопку "Authorize"
- [ ] Формат токена: `Bearer <token>`
- [ ] Токен не истек (проверить через `/api/notification/auth-test`)
- [ ] В клиентском коде добавлен заголовок `Authorization: Bearer <token>`
- [ ] Проверены логи сервера на наличие ошибок JWT

## КОНТАКТЫ

Если проблема не решена, проверьте:
1. Логи сервера
2. Настройки JWT в `appsettings.json`
3. Конфигурацию в `Program.cs`
4. Используйте эндпоинт `/api/notification/auth-test` для диагностики 